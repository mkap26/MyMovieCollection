<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Movie Collection</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use Inter font
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* CSS for the flip animation */
        /* This container maintains the grid item's space */
        .movie-card-container {
            position: relative;
            width: 100%;
            padding-bottom: 150%; /* Maintains a 2:3 aspect ratio */
            perspective: 1000px;
        }
        
        /* This wrapper is absolutely positioned inside the container */
        .movie-card-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        
        .movie-card-wrapper.flipped {
            transform: rotateY(180deg);
        }
        
        .movie-card-front, .movie-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.75rem;
            background-color: #ffffff;
            overflow: hidden; /* Ensures content doesn't bleed out */
        }
        
        .movie-card-back {
            transform: rotateY(180deg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow-y: auto;
        }

        .movie-card-back .back-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }

        .movie-card-back .back-title {
            font-size: 1.1rem;
            line-height: 1.2;
            font-weight: bold;
        }
        
        .movie-card-back .back-year {
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .movie-card-back .details-list,
        .movie-card-back .scores-list {
            font-size: 0.8rem;
            line-height: 1.2;
            margin-top: 0.5rem;
        }
        
        .movie-card-back .scores-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        /* Responsive adjustments for the back of the card */
        @media (min-width: 640px) { /* Reset for larger screens */
            .movie-card-back {
                padding: 1.5rem;
            }
            .movie-card-back .back-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                gap: 1rem;
            }
            .movie-card-back .back-title {
                font-size: 1.25rem;
            }
            .movie-card-back .back-year {
                font-size: 1rem;
            }
            .movie-card-back .details-list,
            .movie-card-back .scores-list {
                font-size: 0.875rem;
                margin-top: 1rem;
            }
        }
        
        /* Specific styles for the front card layout */
        .movie-card-front {
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        .front-content-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0));
            color: #ffffff;
            border-radius: 0 0 0.75rem 0.75rem;
            box-sizing: border-box; /* Ensures padding is included in width calculation */
        }
        
        /* CSS for the movie poster image */
        .poster-image {
            width: 100%;
            height: 100%; 
            object-fit: cover;
            border-radius: 0.75rem;
            flex-shrink: 0;
        }
        
        /* Specific styles for the List View */
        .movie-list-item {
            display: flex;
            align-items: flex-start; /* Aligned items to the top for a cleaner look */
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease;
            position: relative;
            gap: 1rem; /* Added gap for better spacing */
        }
        .movie-list-item:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Responsive adjustments for list view content */
        .list-item-image {
            width: 60px; /* Increased thumbnail size for better visibility */
            height: 90px;
            object-fit: cover;
            border-radius: 0.25rem;
            flex-shrink: 0;
        }
        .list-item-content {
            flex-grow: 1;
        }
        .list-item-details {
            display: flex;
            flex-wrap: wrap; /* Allows details to wrap on small screens */
            gap: 0.5rem;
        }
        .list-item-title {
            font-weight: 600;
            color: #1f2937;
            width: 100%;
            margin-bottom: 0.25rem;
        }
        .list-item-detail {
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }
        .list-item-scores {
            display: flex;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .list-item-details {
                flex-wrap: nowrap; /* Prevent details from wrapping on larger screens */
                justify-content: space-between;
                align-items: center;
            }
            .list-item-title {
                width: auto;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <main class="max-w-7xl mx-auto">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 flex items-center gap-4">
                My Movie Collection
                <div id="status-indicator" class="text-sm font-medium text-gray-600"></div>
            </h1>
            <div id="user-info" class="flex items-center space-x-2" style="display: none;">
                <span id="user-email" class="text-sm text-gray-600 font-medium hidden sm:block"></span>
                <button id="signout-btn" class="px-3 py-1 text-sm bg-red-500 text-white font-bold rounded-md shadow hover:bg-red-600 transition-colors duration-200">
                    Sign Out
                </button>
            </div>
            <button id="login-btn" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-md shadow hover:bg-blue-600 transition-colors duration-200">
                Sign In with Google
            </button>
        </header>

        <div id="authenticated-content" style="display: none;">
            
            <div class="mb-4">
                <input type="text" id="search-input" placeholder="Search movies..." class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
            </div>

            <div class="flex justify-center mb-6">
                <button id="toggle-filters-btn" class="px-6 py-3 bg-gray-200 text-gray-800 font-bold rounded-md shadow hover:bg-gray-300 transition-colors duration-200">
                    Filter & Sort
                </button>
            </div>

            <div id="filter-menu" class="hidden">
                 <div class="flex flex-col lg:flex-row justify-between items-center bg-white p-4 sm:p-6 rounded-xl shadow-md mb-6 gap-4">
                    <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                        <div class="flex items-center space-x-2 w-full sm:w-auto">
                            <label for="sort-by" class="text-gray-700 font-medium whitespace-nowrap">Sort By:</label>
                            <select id="sort-by" class="p-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                                <option value="title" selected>Title</option>
                                <option value="year">Year</option>
                                <option value="rating">Rating</option>
                                <option value="length">Length</option>
                                <option value="genre">Genre</option>
                                <option value="tomatometer">Tomatometer</option>
                                <option value="audienceScore">Audience Score</option>
                                <option value="imdb">IMDb Score</option>
                            </select>
                        </div>
                        
                        <div class="flex items-center space-x-2 w-full sm:w-auto">
                            <label for="filter-by-media" class="text-gray-700 font-medium whitespace-nowrap">Filter by Media:</label>
                            <select id="filter-by-media" class="p-2 border border-gray-300 rounded-md bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                                <option value="all">All</option>
                                <option value="4K Ultra HD">4K Ultra HD</option>
                                <option value="Blu-Ray">Blu-Ray</option>
                                <option value="DVD">DVD</option>
                            </select>
                        </div>
                        
                        <div class="flex-col w-full sm:w-auto">
                            <span class="text-gray-700 font-medium whitespace-nowrap mb-2 block">Filter by Genre:</span>
                            <div id="genre-tags-container" class="flex flex-wrap gap-2 items-center">
                                <button data-genre="all" class="tag-button active px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-full shadow hover:bg-blue-600 transition-colors duration-200">
                                    All
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center space-x-2 w-full sm:w-auto mt-4 sm:mt-0">
                        <span class="text-gray-700 font-medium whitespace-nowrap">View:</span>
                        <button data-view="list" class="view-btn px-3 py-1 bg-gray-200 text-gray-800 font-semibold rounded-md shadow hover:bg-gray-300 transition-colors duration-200">List</button>
                        <button data-view="grid" class="view-btn px-3 py-1 bg-blue-500 text-white font-semibold rounded-md shadow hover:bg-blue-600 transition-colors duration-200">Grid</button>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-2 w-full lg:w-auto mt-4 lg:mt-0">
                        <button id="add-movie-btn" class="w-full sm:w-auto px-6 py-3 bg-green-500 text-white font-bold rounded-md shadow hover:bg-green-600 transition-colors duration-200">
                            Add New Movie
                        </button>
                        <button id="sort-order" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow hover:bg-blue-600 transition-colors duration-200">
                            <span id="sort-order-text">Sort Ascending</span>
                        </button>
                        <button id="reset-filters" class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md shadow hover:bg-gray-300 transition-colors duration-200">
                            Reset
                        </button>
                        <button id="import-btn" class="w-full sm:w-auto px-4 py-2 bg-purple-500 text-white font-semibold rounded-md shadow hover:bg-purple-600 transition-colors duration-200">
                            Import
                        </button>
                        <button id="export-btn" class="w-full sm:w-auto px-4 py-2 bg-indigo-500 text-white font-semibold rounded-md shadow hover:bg-indigo-600 transition-colors duration-200">
                            Export
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="movies-container" class="grid gap-6 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
            </div>
        </div>
    </main>

    <div id="movie-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div id="movie-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300">
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4">Add New Movie</h2>
            <form id="movie-form" class="space-y-4">
                <div>
                    <label for="movie-title" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="movie-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="movie-year" class="block text-sm font-medium text-gray-700">Year</label>
                    <input type="number" id="movie-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="movie-rating" class="block text-sm font-medium text-gray-700">Rating</label>
                    <select id="movie-rating" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="G">G</option>
                        <option value="PG">PG</option>
                        <option value="PG-13">PG-13</option>
                        <option value="R">R</option>
                        <option value="NC-17">NC-17</option>
                        <option value="Not Rated">Not Rated</option>
                    </select>
                </div>
                <div>
                    <label for="movie-length" class="block text-sm font-medium text-gray-700">Length (minutes)</label>
                    <input type="number" id="movie-length" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="movie-genre" class="block text-sm font-medium text-gray-700">Genre (Comma-separated)</label>
                    <input type="text" id="movie-genre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="movie-tomatometer" class="block text-sm font-medium text-gray-700">Tomatometer (%)</label>
                    <input type="number" id="movie-tomatometer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" min="0" max="100">
                </div>
                <div>
                    <label for="movie-audience-score" class="block text-sm font-medium text-gray-700">Audience Score (%)</label>
                    <input type="number" id="movie-audience-score" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" min="0" max="100">
                </div>
                <div>
                    <label for="movie-imdb" class="block text-sm font-medium text-gray-700">IMDb Score (/10)</label>
                    <input type="number" id="movie-imdb" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" step="0.1" min="0" max="10">
                </div>
                <div>
                    <label for="movie-media" class="block text-sm font-medium text-gray-700">Media Type</label>
                    <select id="movie-media" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="4K Ultra HD">4K Ultra HD</option>
                        <option value="Blu-Ray">Blu-Ray</option>
                        <option value="DVD">DVD</option>
                    </select>
                </div>
                <div>
                    <label for="movie-image-url" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                    <input type="url" id="movie-image-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" id="delete-movie-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-md shadow hover:bg-red-600 transition-colors duration-200" style="display: none;">Delete Movie</button>
                    <div class="flex space-x-2 ml-auto">
                        <button type="button" id="cancel-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md shadow hover:bg-gray-300 transition-colors duration-200">Cancel</button>
                        <button type="submit" id="save-movie-btn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md shadow hover:bg-blue-600 transition-colors duration-200">Add Movie</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBf9ZHgLHkIIIH9-C9etHGMf8xTno2K9u8",
            authDomain: "my-movie-collection-1ed74.firebaseapp.com",
            projectId: "my-movie-collection-1ed74",
            storageBucket: "my-movie-collection-1ed74.firebasestorage.app",
            messagingSenderId: "513133972702",
            appId: "1:513133972702:web:f0d4cfbb018f9e815a864f",
            measurementId: "G-S41SMHF1WD"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let moviesCollectionRef;
        let allMovies = [];
        let isAscending = true;
        let currentEditingMovieId = null;
        let currentView = 'grid';
        let selectedGenres = []; // NEW: Array to store selected genre tags

        const CSV_HEADERS = ["title", "year", "rating", "length", "genre", "tomatometer", "audienceScore", "imdb", "media", "imageUrl"];

        const defaultMoviesData = `
        [{ "title": "10 Cloverfield Lane", "year": 2016, "tomatometer": 91, "audienceScore": 79, "imdb": 7.2, "media": "4K Ultra HD", "rating": "PG-13", "length": 103, "genre": ["Sci-Fi", "Thriller"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=10+Cloverfield+Lane" },
            { "title": "American Sniper", "year": 2014, "tomatometer": 34, "audienceScore": 85, "imdb": 7.3, "media": "4K Ultra HD", "rating": "R", "length": 133, "genre": ["Action", "Biography"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=American+Sniper" },
            { "title": "Back to the Future", "year": 1985, "tomatometer": 93, "audienceScore": 95, "imdb": 8.5, "media": "4K Ultra HD", "rating": "PG", "length": 116, "genre": ["Sci-Fi", "Comedy"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=Back+to+the+Future" },
            { "title": "Batman Begins", "year": 2005, "tomatometer": 84, "audienceScore": 89, "imdb": 8.2, "media": "4K Ultra HD", "rating": "PG-13", "length": 140, "genre": ["Action", "Crime"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=Batman+Begins" },
            { "title": "Dune (2021)", "year": 2021, "tomatometer": 83, "audienceScore": 90, "imdb": 8.0, "media": "4K Ultra HD", "rating": "PG-13", "length": 155, "genre": ["Sci-Fi", "Adventure"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=Dune" },
            { "title": "Gladiator", "year": 2000, "tomatometer": 76, "audienceScore": 86, "imdb": 8.5, "media": "DVD", "rating": "R", "length": 155, "genre": ["Action", "Drama"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=Gladiator" },
            { "title": "The Departed", "year": 2006, "tomatometer": 91, "audienceScore": 94, "imdb": 8.5, "media": "Blu-Ray", "rating": "R", "length": 151, "genre": ["Crime", "Thriller"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=The+Departed" },
            { "title": "The Shawshank Redemption", "year": 1994, "tomatometer": 91, "audienceScore": 96, "imdb": 9.3, "media": "4K Ultra HD", "rating": "R", "length": 142, "genre": ["Drama", "Crime"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=The+Shawshank+Redemption" },
            { "title": "The Dark Knight", "year": 2008, "tomatometer": 94, "audienceScore": 94, "imdb": 9.0, "media": "4K Ultra HD", "rating": "PG-13", "length": 152, "genre": ["Action", "Crime", "Drama"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=The+Dark+Knight" },
            { "title": "Pulp Fiction", "year": 1994, "tomatometer": 92, "audienceScore": 96, "imdb": 8.9, "media": "Blu-Ray", "rating": "R", "length": 154, "genre": ["Crime", "Drama"], "imageUrl": "https://placehold.co/300x450/e0e0e0/555555?text=Pulp+Fiction" }
        ]`;

        function createMovieCard(movie, isListView = false) {
            const genresString = Array.isArray(movie.genre) ? movie.genre.join(', ') : movie.genre || 'N/A';
            if (isListView) {
                const listItem = document.createElement('div');
                listItem.classList.add('movie-list-item', 'relative', 'group', 'p-4', 'flex', 'flex-col', 'sm:flex-row', 'sm:items-center', 'sm:justify-between');
                listItem.setAttribute('data-movie-id', movie.id);

                const leftSection = document.createElement('div');
                leftSection.classList.add('flex', 'items-center', 'space-x-4', 'w-full', 'sm:w-auto');
                
                const image = document.createElement('img');
                image.src = movie.imageUrl || `https://placehold.co/50x75/e0e0e0/555555?text=No+Image`;
                image.alt = `Poster for ${movie.title}`;
                image.classList.add('list-item-image');
                leftSection.appendChild(image);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('flex', 'flex-col', 'space-y-1', 'flex-grow');

                const title = document.createElement('span');
                title.textContent = `${movie.title} (${movie.year})`;
                title.classList.add('list-item-title');
                contentWrapper.appendChild(title);

                const detailsSection = document.createElement('div');
                detailsSection.classList.add('flex', 'flex-wrap', 'gap-x-2', 'gap-y-1', 'text-xs', 'text-gray-500');
                detailsSection.innerHTML = `
                    <span>Rating: ${movie.rating || 'N/A'}</span>
                    <span>Length: ${movie.length ? `${movie.length} min` : 'N/A'}</span>
                    <span>Media: ${movie.media}</span>
                    <span>Genre: ${genresString}</span>
                `;
                contentWrapper.appendChild(detailsSection);

                leftSection.appendChild(contentWrapper);
                listItem.appendChild(leftSection);


                const scoresDiv = document.createElement('div');
                scoresDiv.classList.add('flex', 'flex-wrap', 'gap-2', 'mt-2', 'sm:mt-0', 'sm:ml-4', 'text-sm', 'text-gray-600', 'sm:w-auto');
                scoresDiv.innerHTML = `
                    <span class="whitespace-nowrap">🍅 ${movie.tomatometer}%</span>
                    <span class="whitespace-nowrap">🍿 ${movie.audienceScore}%</span>
                    <span class="whitespace-nowrap">⭐ ${movie.imdb}/10</span>
                `;
                listItem.appendChild(scoresDiv);

                const editButton = document.createElement('button');
                editButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-blue-500 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.757 1.586l-2.828 2.828-6.172 6.172a2 2 0 00-.586 1.414V17a1 1 0 001 1h4.172a2 2 0 001.414-.586l6.172-6.172-2.828-2.828-6.172 6.172z" />
                    </svg>
                `;
                editButton.classList.add('absolute', 'top-1/2', '-translate-y-1/2', 'right-4', 'p-1', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 'duration-200');
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModalForEdit(movie.id);
                });
                listItem.appendChild(editButton);
                
                return listItem;
            } else {
                const cardContainer = document.createElement('div');
                cardContainer.classList.add('movie-card-container');
                cardContainer.setAttribute('data-movie-id', movie.id);
                
                const cardWrapper = document.createElement('div');
                cardWrapper.classList.add('movie-card-wrapper');
                
                const cardFront = document.createElement('div');
                cardFront.classList.add('movie-card-front');
                
                const editButton = document.createElement('button');
                editButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 hover:text-blue-500 transition-colors" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-4.757 1.586l-2.828 2.828-6.172 6.172a2 2 0 00-.586 1.414V17a1 1 0 001 1h4.172a2 2 0 001.414-.586l6.172-6.172-2.828-2.828-6.172 6.172z" />
                    </svg>
                `;
                editButton.classList.add('absolute', 'top-2', 'left-2', 'p-1', 'rounded-full', 'bg-white', 'hover:bg-gray-100', 'transition-colors', 'duration-200', 'z-20');
                editButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModalForEdit(movie.id);
                });
                cardFront.appendChild(editButton);

                const image = document.createElement('img');
                image.src = movie.imageUrl || `https://placehold.co/300x450/e0e0e0/555555?text=${movie.title.replace(/ /g, '+')}`;
                image.alt = `Poster for ${movie.title}`;
                image.classList.add('poster-image');
                cardFront.appendChild(image);

                const frontContent = document.createElement('div');
                frontContent.classList.add('front-content-overlay');

                const titleHeading = document.createElement('h2');
                titleHeading.classList.add('text-lg', 'font-semibold', 'text-white', 'mb-1');
                titleHeading.textContent = `${movie.title} (${movie.year})`;
                frontContent.appendChild(titleHeading);

                cardFront.appendChild(frontContent);


                const cardBack = document.createElement('div');
                cardBack.classList.add('movie-card-back');
                
                const backHeader = document.createElement('div');
                backHeader.classList.add('back-header');
                const backTitle = document.createElement('h2');
                backTitle.classList.add('back-title');
                backTitle.textContent = movie.title;
                const backYear = document.createElement('span');
                backYear.classList.add('back-year');
                backYear.textContent = `(${movie.year})`;
                backHeader.appendChild(backTitle);
                backHeader.appendChild(backYear);
                cardBack.appendChild(backHeader);

                const detailsList = document.createElement('ul');
                detailsList.classList.add('details-list');
                detailsList.innerHTML = `
                    <li><strong>Rating:</strong> ${movie.rating || 'N/A'}</li>
                    <li><strong>Length:</strong> ${movie.length ? `${movie.length} min` : 'N/A'}</li>
                    <li><strong>Genre:</strong> ${genresString}</li>
                    <li><strong>Media:</strong> ${movie.media}</li>
                `;
                cardBack.appendChild(detailsList);
                
                const scoresList = document.createElement('ul');
                scoresList.classList.add('scores-list');
                scoresList.innerHTML = `
                    <li>🍅 <strong>Tomatometer:</strong> ${movie.tomatometer}%</li>
                    <li>🍿 <strong>Audience:</strong> ${movie.audienceScore}%</li>
                    <li>⭐ <strong>IMDb:</strong> ${movie.imdb}/10</li>
                `;
                cardBack.appendChild(scoresList);

                cardWrapper.appendChild(cardFront);
                cardWrapper.appendChild(cardBack);
                cardContainer.appendChild(cardWrapper);
                
                cardContainer.addEventListener('click', () => {
                    cardWrapper.classList.toggle('flipped');
                });

                return cardContainer;
            }
        }

        function updateStatusIndicator(movies) {
            const indicator = document.getElementById('status-indicator');
            
            if (!movies || movies.length === 0) {
                indicator.innerHTML = `No movies found. Add your first movie!`;
                return;
            }
            
            const total = movies.length;
            let html = `Total Movies: <strong>${total}</strong>`;
            
            indicator.innerHTML = html;
        }

        function populateGenreFilter(movies) {
            const genreTagContainer = document.getElementById('genre-tags-container');
            const uniqueGenres = new Set();
            
            movies.forEach(movie => {
                if (Array.isArray(movie.genre)) {
                    movie.genre.forEach(g => uniqueGenres.add(g.trim()));
                } else if (movie.genre) {
                    uniqueGenres.add(movie.genre.trim());
                }
            });
            
            // Clear existing options, but keep the 'All' button
            genreTagContainer.innerHTML = `
                <button data-genre="all" class="tag-button px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-full shadow hover:bg-blue-600 transition-colors duration-200">
                    All
                </button>
            `;
            
            const sortedGenres = Array.from(uniqueGenres).sort();
            sortedGenres.forEach(genre => {
                if (genre) {
                    const button = document.createElement('button');
                    button.textContent = genre;
                    button.dataset.genre = genre;
                    button.classList.add('tag-button', 'px-3', 'py-1', 'bg-gray-200', 'text-gray-800', 'text-sm', 'font-semibold', 'rounded-full', 'shadow', 'hover:bg-gray-300', 'transition-colors', 'duration-200');
                    genreTagContainer.appendChild(button);
                }
            });
        }
        
        function handleGenreTagClick(event) {
            const clickedGenre = event.target.dataset.genre;
            
            if (clickedGenre === 'all') {
                selectedGenres = [];
                document.querySelectorAll('#genre-tags-container .tag-button').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                document.querySelector('#genre-tags-container button[data-genre="all"]').classList.remove('bg-gray-200', 'text-gray-800');
                document.querySelector('#genre-tags-container button[data-genre="all"]').classList.add('bg-blue-500', 'text-white');
            } else {
                const isSelected = selectedGenres.includes(clickedGenre);
                if (isSelected) {
                    selectedGenres = selectedGenres.filter(g => g !== clickedGenre);
                    event.target.classList.remove('bg-blue-500', 'text-white');
                    event.target.classList.add('bg-gray-200', 'text-gray-800');
                } else {
                    selectedGenres.push(clickedGenre);
                    event.target.classList.remove('bg-gray-200', 'text-gray-800');
                    event.target.classList.add('bg-blue-500', 'text-white');
                    // Deselect 'All' button
                    document.querySelector('#genre-tags-container button[data-genre="all"]').classList.remove('bg-blue-500', 'text-white');
                    document.querySelector('#genre-tags-container button[data-genre="all"]').classList.add('bg-gray-200', 'text-gray-800');
                }
                
                if (selectedGenres.length === 0) {
                    handleGenreTagClick({ target: { dataset: { genre: 'all' } } });
                }
            }

            filterAndSortMovies();
        }


        function filterAndSortMovies() {
            const sortBy = document.getElementById('sort-by').value;
            const filterByMedia = document.getElementById('filter-by-media').value;
            const moviesContainer = document.getElementById('movies-container');
            const searchQuery = document.getElementById('search-input').value.toLowerCase();

            let filteredMovies = allMovies;
            
            if (filterByMedia !== 'all') {
                filteredMovies = filteredMovies.filter(movie => movie.media === filterByMedia);
            }
            
            if (selectedGenres.length > 0) {
                filteredMovies = filteredMovies.filter(movie => {
                    const genres = Array.isArray(movie.genre) ? movie.genre : [movie.genre];
                    return selectedGenres.some(selectedGenre => genres.includes(selectedGenre));
                });
            }

            if (searchQuery) {
                filteredMovies = filteredMovies.filter(movie => movie.title.toLowerCase().includes(searchQuery));
            }

            filteredMovies.sort((a, b) => {
                let aValue, bValue;
                if (sortBy === 'title' || sortBy === 'rating' || sortBy === 'genre') {
                    aValue = a[sortBy];
                    bValue = b[sortBy];
                    if (sortBy === 'genre') {
                         aValue = Array.isArray(a.genre) ? a.genre.join(', ') : a.genre;
                         bValue = Array.isArray(b.genre) ? b.genre.join(', ') : b.genre;
                    }
                    aValue = aValue ? aValue.toLowerCase() : '';
                    bValue = bValue ? bValue.toLowerCase() : '';
                    return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                } else {
                    aValue = a[sortBy] || 0;
                    bValue = b[sortBy] || 0;
                }

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });
            
            moviesContainer.innerHTML = '';
            
            filteredMovies.forEach((movie) => {
                const movieCard = createMovieCard(movie, currentView === 'list');
                moviesContainer.appendChild(movieCard);
            });

            updateStatusIndicator(filteredMovies);
        }

        function setView(view) {
            currentView = view;
            const moviesContainer = document.getElementById('movies-container');
            
            moviesContainer.classList.remove('grid', 'flex', 'flex-col', 'gap-6', 'space-y-4', 'grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5');
            
            if (view === 'list') {
                moviesContainer.classList.add('flex', 'flex-col', 'space-y-4');
            } else if (view === 'grid') {
                moviesContainer.classList.add('grid', 'gap-6', 'grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5');
            }

            filterAndSortMovies();
        }
        
        function openModalForAdd() {
            currentEditingMovieId = null;
            const form = document.getElementById('movie-form');
            form.reset();
            document.getElementById('modal-title').textContent = 'Add New Movie';
            document.getElementById('save-movie-btn').textContent = 'Add Movie';
            document.getElementById('delete-movie-btn').style.display = 'none';

            document.getElementById('movie-modal-backdrop').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('movie-modal-backdrop').classList.replace('pointer-events-none', 'pointer-events-auto');
            document.getElementById('movie-modal').classList.replace('scale-95', 'scale-100');
        }

        function openModalForEdit(movieId) {
            currentEditingMovieId = movieId;
            const movie = allMovies.find(m => m.id === movieId);
            
            document.getElementById('modal-title').textContent = 'Edit Movie';
            document.getElementById('save-movie-btn').textContent = 'Save Changes';
            document.getElementById('delete-movie-btn').style.display = 'block';

            document.getElementById('movie-title').value = movie.title;
            document.getElementById('movie-year').value = movie.year;
            document.getElementById('movie-rating').value = movie.rating;
            document.getElementById('movie-length').value = movie.length;
            document.getElementById('movie-genre').value = Array.isArray(movie.genre) ? movie.genre.join(', ') : movie.genre;
            document.getElementById('movie-tomatometer').value = movie.tomatometer;
            document.getElementById('movie-audience-score').value = movie.audienceScore;
            document.getElementById('movie-imdb').value = movie.imdb;
            document.getElementById('movie-media').value = movie.media;
            document.getElementById('movie-image-url').value = movie.imageUrl || '';
            
            document.getElementById('delete-movie-btn').onclick = () => {
                if (confirm("Are you sure you want to delete this movie?")) {
                    deleteMovie(movieId);
                    closeModal();
                }
            };

            document.getElementById('movie-modal-backdrop').classList.replace('opacity-0', 'opacity-100');
            document.getElementById('movie-modal-backdrop').classList.replace('pointer-events-none', 'pointer-events-auto');
            document.getElementById('movie-modal').classList.replace('scale-95', 'scale-100');
        }

        function closeModal() {
            document.getElementById('movie-modal-backdrop').classList.replace('opacity-100', 'opacity-0');
            document.getElementById('movie-modal-backdrop').classList.replace('pointer-events-auto', 'pointer-events-none');
            document.getElementById('movie-modal').classList.replace('scale-100', 'scale-95');
            document.getElementById('movie-form').reset();
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('movie-title').value;
            const year = parseInt(document.getElementById('movie-year').value);
            const rating = document.getElementById('movie-rating').value;
            const length = parseInt(document.getElementById('movie-length').value) || null;
            // UPDATED: Convert comma-separated string to array
            const genre = document.getElementById('movie-genre').value.split(',').map(g => g.trim()).filter(g => g.length > 0);
            const tomatometer = parseInt(document.getElementById('movie-tomatometer').value) || 0;
            const audienceScore = parseInt(document.getElementById('movie-audience-score').value) || 0;
            const imdb = parseFloat(document.getElementById('movie-imdb').value) || 0;
            const media = document.getElementById('movie-media').value;
            const imageUrl = document.getElementById('movie-image-url').value || null;
            
            const newOrUpdatedMovie = { title, year, rating, length, genre, tomatometer, audienceScore, imdb, media, imageUrl };
            
            try {
                if (currentEditingMovieId) {
                    await setDoc(doc(moviesCollectionRef, currentEditingMovieId), newOrUpdatedMovie);
                } else {
                    await addDoc(moviesCollectionRef, newOrUpdatedMovie);
                }
            } catch (e) {
                console.error("Error adding/updating document: ", e);
            }
            
            closeModal();
        }
        
        async function deleteMovie(movieId) {
            if (confirm("Are you sure you want to delete this movie?")) {
                try {
                    await deleteDoc(doc(moviesCollectionRef, movieId));
                    console.log("Document successfully deleted!");
                } catch (e) {
                    console.error("Error removing document: ", e);
                }
            }
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google Sign-In:", error);
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during Sign-Out:", error);
            }
        }

        // CSV helper function to escape strings
        function escapeCsv(value) {
            if (value === null || value === undefined) {
                return '';
            }
            // UPDATED: Handle array values for CSV export
            if (Array.isArray(value)) {
                value = value.join(', ');
            }
            const stringValue = String(value);
            const escapedValue = stringValue.replace(/"/g, '""');
            if (escapedValue.includes(',') || escapedValue.includes('\n')) {
                return `"${escapedValue}"`;
            }
            return escapedValue;
        }

        // NEW: Export to CSV Function
        function exportData() {
            const moviesToExport = allMovies.map(({ id, ...rest }) => rest);
            
            if (moviesToExport.length === 0) {
                alert("No movies to export!");
                return;
            }

            const headers = CSV_HEADERS.map(header => escapeCsv(header)).join(',');
            
            const csvRows = moviesToExport.map(movie => 
                CSV_HEADERS.map(header => escapeCsv(movie[header])).join(',')
            );
            
            const csvString = [headers, ...csvRows].join('\n');
            
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
        
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movie_collection.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('Export to CSV complete.');
        }
        
        // NEW: Import from CSV Function
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n').filter(line => line.trim() !== '');
                    if (lines.length < 2) {
                        alert('Invalid CSV file. It must contain a header and at least one row of data.');
                        return;
                    }
                    
                    const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(header => header.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                    
                    const existingMoviesMap = new Map();
                    if (allMovies) {
                        allMovies.forEach(movie => {
                            existingMoviesMap.set(movie.title, movie.id);
                        });
                    }
                    
                    let importedCount = 0;
                    let updatedCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(val => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                        
                        if (values.length !== headers.length) {
                             console.warn(`Skipping malformed row: "${lines[i]}"`);
                             continue;
                        }

                        const movie = {};
                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (header === 'year' || header === 'length' || header === 'tomatometer' || header === 'audienceScore') {
                                movie[header] = parseInt(value) || 0;
                            } else if (header === 'imdb') {
                                movie[header] = parseFloat(value) || 0;
                            } else if (header === 'genre') {
                                // UPDATED: Convert comma-separated string back to array on import
                                movie[header] = value ? value.split(',').map(g => g.trim()) : [];
                            } else {
                                movie[header] = value;
                            }
                        });
                        
                        const existingId = existingMoviesMap.get(movie.title);
                        if (existingId) {
                            await setDoc(doc(moviesCollectionRef, existingId), movie);
                            updatedCount++;
                        } else {
                            await addDoc(moviesCollectionRef, movie);
                            importedCount++;
                        }
                    }

                    if (importedCount === 0 && updatedCount === 0) {
                        alert('No valid movie data found in the CSV file.');
                    } else {
                         alert(`Import complete! ${importedCount} movies added, ${updatedCount} movies updated.`);
                    }
                   
                } catch (error) {
                    console.error("Error importing data:", error);
                    alert('Failed to import movies. Please check the file format and try again.');
                }
            };
            reader.readAsText(file);
        }

        function init() {
            onAuthStateChanged(auth, async (user) => {
                const loginButton = document.getElementById('login-btn');
                const authenticatedContent = document.getElementById('authenticated-content');
                const userInfoDiv = document.getElementById('user-info');
                const userEmailSpan = document.getElementById('user-email');

                if (user) {
                    console.log("User is authenticated:", user.uid);
                    loginButton.style.display = 'none';
                    userInfoDiv.style.display = 'flex';
                    userEmailSpan.textContent = user.email;
                    authenticatedContent.style.display = 'block';
                    
                    moviesCollectionRef = collection(db, `users/${user.uid}/movies`);

                    onSnapshot(moviesCollectionRef, (snapshot) => {
                        const moviesFromDb = [];
                        snapshot.forEach(doc => {
                            moviesFromDb.push({ id: doc.id, ...doc.data() });
                        });
                        allMovies = moviesFromDb;
                        populateGenreFilter(allMovies);
                        filterAndSortMovies();
                    });
                } else {
                    console.log("No user is authenticated.");
                    loginButton.style.display = 'block';
                    userInfoDiv.style.display = 'none';
                    authenticatedContent.style.display = 'none';
                    
                    allMovies = [];
                    filterAndSortMovies();
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('add-movie-btn').addEventListener('click', openModalForAdd);
            document.getElementById('cancel-modal-btn').addEventListener('click', closeModal);
            document.getElementById('movie-form').addEventListener('submit', handleFormSubmit);

            document.getElementById('login-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('signout-btn').addEventListener('click', handleSignOut);
            
            document.getElementById('export-btn').addEventListener('click', exportData);
            
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.accept = 'text/csv';
            importInput.style.display = 'none';
            importInput.addEventListener('change', importData);
            document.body.appendChild(importInput);

            document.getElementById('import-btn').addEventListener('click', () => {
                importInput.click();
            });

            document.querySelectorAll('.view-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    document.querySelectorAll('.view-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-800');
                    });
                    event.target.classList.remove('bg-gray-200', 'text-gray-800');
                    event.target.classList.add('bg-blue-500', 'text-white');
                    
                    const viewType = event.target.dataset.view;
                    setView(viewType);
                });
            });

            document.getElementById('sort-by').addEventListener('change', filterAndSortMovies);
            document.getElementById('filter-by-media').addEventListener('change', filterAndSortMovies);
            
            // NEW: Add a click listener to the genre tag container
            document.getElementById('genre-tags-container').addEventListener('click', handleGenreTagClick);

            document.getElementById('sort-order').addEventListener('click', () => {
                isAscending = !isAscending;
                document.getElementById('sort-order-text').textContent = isAscending ? 'Sort Ascending' : 'Sort Descending';
                filterAndSortMovies();
            });
            document.getElementById('reset-filters').addEventListener('click', () => {
                document.getElementById('sort-by').value = 'title';
                document.getElementById('filter-by-media').value = 'all';
                selectedGenres = []; // Reset selected genres
                
                // Visually reset genre tags
                document.querySelectorAll('#genre-tags-container .tag-button').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                document.querySelector('#genre-tags-container button[data-genre="all"]').classList.remove('bg-gray-200', 'text-gray-800');
                document.querySelector('#genre-tags-container button[data-genre="all"]').classList.add('bg-blue-500', 'text-white');

                document.getElementById('search-input').value = '';

                isAscending = true; 
                document.getElementById('sort-order-text').textContent = 'Sort Ascending';

                setView('grid');
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                document.querySelector('[data-view="grid"]').classList.remove('bg-gray-200', 'text-gray-800');
                document.querySelector('[data-view="grid"]').classList.add('bg-blue-500', 'text-white');

                filterAndSortMovies();
            });
            document.getElementById('search-input').addEventListener('keyup', filterAndSortMovies);
            
            document.getElementById('toggle-filters-btn').addEventListener('click', () => {
                document.getElementById('filter-menu').classList.toggle('hidden');
            });

            init();
        });
    </script>
</body>
</html>
